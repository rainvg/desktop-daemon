var path=require("path"),fs=require("fs"),needle=require("needle"),nappy=require("nappy"),universal_analytics=require("universal-analytics"),battery_charge=require("./daemons/battery-charge.js"),_user,_version,settings={remote:"https://rain.vg/api/events",thresholds:{event_flush:20},intervals:{sync:3e4,analytics:12e4}},_path={buffer:path.resolve(__dirname,"..","..","resources","events_buffer"),queue:path.resolve(__dirname,"..","..","resources","events_queue")},analytics={client:null,keepalive:function(){analytics.client.event("event","online").send()}},events={push:function(e){e.user=_user,e.time=Math.floor((new Date).getTime()/1e3),e.version=_version,fs.appendFileSync(_path.buffer,JSON.stringify(e)+"\n")},sync:function(){nappy.wait.connection().then(function(){analytics.client.event("sync","try").send();try{fs.appendFileSync(_path.queue,fs.readFileSync(_path.buffer)),fs.unlinkSync(_path.buffer)}catch(e){}var n=[];try{n=fs.readFileSync(_path.queue).toString().split("\n")}catch(e){}var t=[];n.forEach(function(e){try{t.push(JSON.parse(e))}catch(n){}}),t.length<settings.thresholds.event_flush?nappy.wait["for"](settings.intervals.sync).then(events.sync):needle.request("post",settings.remote,t,{json:!0},function(e,n){if(!e&&200===n.statusCode&&"success"===n.body.status)try{fs.unlinkSync(_path.queue),analytics.client.event("sync","success").send()}catch(e){analytics.client.event("sync","failed").send()}nappy.wait["for"](settings.intervals.sync).then(events.sync)})})}};module.exports=function(e,n){_user=e,_version=n,analytics.client=universal_analytics("UA-76368254-1",_user,{https:!0,strictCidFormat:!1}),analytics.client.event("start",_version).send(),setInterval(analytics.keepalive,settings.intervals.analytics),battery_charge(events,analytics),events.sync()};
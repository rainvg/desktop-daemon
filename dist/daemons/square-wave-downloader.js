var os=require("os"),fs=require("fs-extra"),path=require("path"),needle=require("needle"),settings={period:36e5,interval:3e4,size:1048576,endpoint:"https://rain.vg/downloads/cpu_testfile",path:path.resolve(__dirname,"..","..","..","resources","cpu_testfile"),needle:{open_timeout:5e3,read_timeout:2e4}},_events,_analytics,_level={time_slice:0,phase:!1},download=function(){return"darwin"===os.platform()||"win32"===os.platform()?new Promise(function(e,t){needle.get(settings.endpoint,settings.needle,function(n,s){if(n||200!==s.statusCode)return void t();try{fs.writeFileSync(settings.path,s.body);var i=fs.statSync(settings.path).size;fs.unlinkSync(settings.path),i===settings.size?e():t()}catch(n){t()}})}):Promise.reject()},__level__=function(){var e=Math.floor((new Date).getTime()/settings.period);e!==_level.time_slice&&(_level.time_slice=e,_level.phase=Math.random()<.5);var t=(new Date).getTime()%settings.period>settings.period/2;return _level.phase&&!t||!_level.phase&&t},__run__=function(){__level__()&&download().then(function(){_events.push({type:"square-wave-downloader"}),_analytics.client.event("square-wave-downloader","success").send()})};module.exports=function(e,t){_events=e,_analytics=t,setInterval(__run__,settings.interval)};